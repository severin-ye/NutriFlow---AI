# 🌐 营养数据联网查询功能说明

## 📋 功能概述

系统已升级为**联网实时查询**营养数据，不再依赖本地CSV数据库。

### ✨ 主要优势

1. **实时准确** - 从权威营养数据库(中国食物成分表、USDA等)获取最新数据
2. **覆盖全面** - 不受本地数据库限制，支持查询任意菜品
3. **智能估算** - 对于复杂菜品(如宫保鸡丁)，AI会基于常见做法估算平均营养值
4. **容错机制** - 当联网失败时，自动使用智能分类估算值

## 🔧 技术实现

### 核心代码位置
`tools/nutrition_tools.py`

### 实现方式
```python
# 使用 Qwen-Plus 模型 + 联网搜索
client.chat.completions.create(
    model="qwen-plus",
    messages=[...]
)
```

### 查询流程
```
用户输入菜品名
    ↓
Qwen-Plus 联网搜索权威数据源
    ↓
解析并返回标准化 JSON 格式
    ↓
{
  "calories": 数值,
  "protein": 数值,
  "fat": 数值,
  "carbs": 数值,
  "sodium": 数值
}
```

## 📊 查询示例

### 示例1: 基础食材
```python
query_nutrition_per_100g("白米饭")

# 返回:
{
  "calories": 130.0,
  "protein": 2.7,
  "fat": 0.3,
  "carbs": 28.2,
  "sodium": 2.0
}
```

### 示例2: 复杂菜品
```python
query_nutrition_per_100g("宫保鸡丁")

# 返回 (基于常见做法的平均值):
{
  "calories": 125.3,
  "protein": 9.8,
  "fat": 6.7,
  "carbs": 7.2,
  "sodium": 380.5
}
```

## 🛡️ 容错机制

### 三级保护

1. **正常查询** - 联网获取权威数据 ✅
2. **JSON解析失败** - 使用智能分类估算
3. **网络异常** - 使用智能分类估算

### 智能分类估算规则

当联网查询失败时，系统会根据菜品名称关键词自动分类：

| 类别 | 关键词 | 估算值特点 |
|-----|--------|-----------|
| **主食类** | 米饭、馒头、面条、面包 | 高碳水、低脂肪 |
| **肉类** | 鸡、猪、牛、羊、鱼、虾 | 高蛋白、适中脂肪 |
| **蔬菜类** | 菜、瓜、笋、菌、豆 | 低热量、高纤维 |
| **汤类** | 汤、羹 | 低热量、高钠 |
| **混合菜** | 其他 | 均衡营养 |

## 🔄 与旧版本的对比

| 维度 | 旧版(本地CSV) | 新版(联网查询) |
|-----|-------------|---------------|
| **数据源** | 本地20种食物 | 全网权威数据库 |
| **准确性** | 固定值 | 实时查询 |
| **覆盖范围** | 有限 | 无限制 |
| **维护成本** | 需手动更新 | 自动获取 |
| **查询速度** | 极快(毫秒级) | 快(1-3秒) |
| **离线可用** | ✅ | ❌ (但有容错) |

## 🎯 使用建议

### 适用场景
- ✅ 需要准确营养数据的场景
- ✅ 需要查询罕见菜品
- ✅ 需要最新食物数据
- ✅ 有稳定网络连接

### 注意事项
1. **网络依赖** - 确保有稳定的网络连接
2. **API配额** - 注意通义千问API的调用次数限制
3. **查询时间** - 每次查询约需1-3秒（比本地慢但更准确）
4. **复杂菜品** - 对于复杂烹饪菜品，结果是基于常见做法的估算

## 🧪 测试方法

```bash
# 进入项目目录
cd /home/severin/Codelib/HCI

# 激活虚拟环境
source .venv/bin/activate

# 运行测试
python3 tools/nutrition_tools.py
```

测试会查询以下菜品:
- 白米饭
- 宫保鸡丁
- 清蒸鲈鱼
- 西兰花炒虾仁
- 红烧肉
- 番茄炒蛋

## 📝 更新日志

### v2.0 (2025-12-08)
- ✅ 将本地CSV查询改为联网实时查询
- ✅ 集成 Qwen-Plus 模型联网搜索能力
- ✅ 添加智能分类容错机制
- ✅ 优化JSON解析逻辑
- ✅ 提供详细的查询日志

## 🔮 未来优化方向

1. **缓存机制** - 对常见菜品添加缓存，减少API调用
2. **多源验证** - 同时查询多个数据源，取平均值
3. **用户反馈** - 允许用户纠正不准确的数据
4. **离线模式** - 提供离线数据包作为备选
