---

# 🧱 一、系统架构（JSON 数据库版本）

```
前端（或 CLI）
    ↓  图片与请求
后端 Nutrition Agent（LangChain + LangGraph）
    ↓
[工具层 Tools] ——（所有数据通过工具处理）
    VisionTool：识别菜 & 粗估分量
    PortionVerifyTool：分量合理性校验
    NutritionQueryTool：查每 100g 营养
    ComputeTool：计算整餐营养
    HistoryTool：读 JSON 数据库（最近一周）
    SaveTool：写 JSON 数据库（追加）
    NextMealTool：下一餐推荐
    ScoreTool：本餐评分 / 趋势评分

```

数据库只有一个：

```
db/
 └── meals.json   ← 主数据库文件（你存所有天 → 所有餐 → 所有菜）

```

---

# 🗃️ 二、JSON 数据库结构（最终版）

数据库文件：`db/meals.json`

```json
{
  "user_id": "user001",
  "days": [
    {
      "date": "2025-12-07",
      "daily_summary": {
        "total_calories": 0,
        "total_protein": 0,
        "total_fat": 0,
        "total_carbs": 0,
        "total_sodium": 0,
        "daily_score": 0
      },
      "meals": []
    }
  ]
}

```

（你已经确认此结构，不再赘述）

---

# 🛠️ 三、技术路径（可以照做的步骤）

---

## **步骤 1：准备 Python 项目目录**

```
ai-nutrition-agent/
├── agent.py
├── tools/
│   ├── vision_tools.py
│   ├── portion_tools.py
│   ├── nutrition_tools.py
│   ├── compute_tools.py
│   ├── db_tools.py
│   └── recommendation_tools.py
├── schemas/
│   ├── meal_schema.py
│   └── tool_schema.py
├── db/
│   └── meals.json  ← 主数据库
├── config/
│   └── settings.py
└── requirements.txt

```

---

## **步骤 2：定义所有核心 Schema（Pydantic）**

这些 Schema 和数据库一一对应，是可直接用于结构化输出的官方推荐方式（教程里也强调优先用 Pydantic）。

例如（`schemas/meal_schema.py`）：

```python
class Nutrition(BaseModel):
    calories: float
    protein: float
    fat: float
    carbs: float
    sodium: float

class Dish(BaseModel):
    dish_id: str
    name: str
    category: str
    portion_estimation: PortionEstimation
    nutrition_per_100g: Nutrition
    nutrition_total: Nutrition

class Meal(BaseModel):
    meal_id: str
    timestamp: str
    meal_type: str
    dishes: List[Dish]
    nutrition_total: Nutrition
    scores: MealScores
    advice: MealAdvice
    next_meal_recommendation: NextMealRecommendation

```

Schema 是整个系统的核心，会确保 JSON 输出结构稳定，不会乱。

---

## **步骤 3：工具 Tools 的技术路径（核心）**

LangChain 教程中说 Tools 是构建 Agent 的基本执行单元。

我们现在根据你的业务把 Tools 全部落地。

---

### ✔ **Tool 1 — VisionTool：图片 → 多道菜 + 粗估分量**

文件：`tools/vision_tools.py`

功能：

- 调用 Qwen-VL（或 GPT4V）识别多道菜
- 输出每道菜的：名字、类别、份量估计（克）、理由

```python
@tool(args_schema=VisionInput)
def detect_dishes_and_portions(image_path: str):
    """
    调用 Qwen-VL，识别菜品，给出粗估重量。
    """
    # 1. 构造 multimodal prompt
    # 2. mm_model.invoke(...)
    # 3. JSON 格式输出
    return {...}

```

---

### ✔ **Tool 2 — PortionVerifyTool：分量合理性校验**

文件：`tools/portion_tools.py`

功能：

- 检查生成的分量是否合理
- 不合理就重新估计

```python
@tool(args_schema=PortionCheckInput)
def check_and_refine_portions(dishes: List[dict]):
    """
    模型判断重量是否合理；不合理则重新生成分量。
    完整输出 PortionEstimation。
    """
    return {...}

```

---

### ✔ **Tool 3 — NutritionQueryTool：查每 100g 营养**

文件：`tools/nutrition_tools.py`

本地 CSV，如 `nutrition_db.csv`

模糊匹配菜名。

```python
@tool(args_schema=NutritionQuery)
def query_nutrition_per_100g(dish_name: str):
    return {
      "calories": ...,
      "protein": ...,
      "fat": ...,
      "carbs": ...,
      "sodium": ...
    }

```

---

### ✔ **Tool 4 — ComputeTool：计算整餐营养**

文件：`tools/compute_tools.py`

```python
@tool
def compute_meal_nutrition(dishes: List[dict]):
    """
    final_weight × 每100g营养 → 每道菜营养
    并汇总整餐营养
    """
    return {
      "dishes": dishes_with_total,
      "meal_nutrition_total": {...}
    }

```

---

### ✔ **Tool 5 — load_recent_meals：读取最近 7 天 JSON 数据**

文件：`tools/db_tools.py`

```python
@tool
def load_recent_meals(days: int = 7):
    db = _load_json()
    # 过滤最近7天
    return recent_records

```

---

### ✔ **Tool 6 — save_meal：将本餐写入 JSON 数据库**

数据库就一个文件，更新逻辑：

- 若当天不存在 → 创建一天
- 若当天已存在 → append meal
- 更新 daily_summary

```python
@tool
def save_meal(meal: dict):
    db = _load_json()
    # 找日 → 加餐 → 更新 summary → 存回
    _save_json(db)
    return "ok"

```

---

### ✔ **Tool 7 — NextMealTool：下一餐推荐**

文件：`tools/recommendation_tools.py`

输入：

- 本餐营养
- 最近一周趋势

输出：

- 推荐菜品组合
- 推荐理由

```python
@tool
def recommend_next_meal(current_nutrition: dict, recent_history: dict):
    """
    根据本餐营养 + 一周趋势，给下一餐推荐。
    """
    return {
        "options": [...],
        "overall_reason": "..."
    }

```

---

# 🧠 步骤 4：Agent（LangChain + LangGraph）编排流程

文件：`agent.py`

使用教程中的 create_agent 模式。

```
tools = [
    detect_dishes_and_portions,
    check_and_refine_portions,
    query_nutrition_per_100g,
    compute_meal_nutrition,
    load_recent_meals,
    recommend_next_meal,
    save_meal
]

agent = create_agent(
    model=llm_text,
    tools=tools,
    system_prompt=system_prompt,
)
graph = agent   # 用于 LangGraph CLI

```

---

# 🔁 步骤 5：完整执行链路（Agent 自动调用 Tools）

当你调用 Agent：

```
“这是我中午的餐盘图片，请分析。”

```

Agent 自动执行以下链：

1. detect_dishes_and_portions
2. check_and_refine_portions
3. query_nutrition_per_100g（对每道菜循环）
4. compute_meal_nutrition
5. load_recent_meals（用于趋势分析）
6. recommend_next_meal
7. save_meal（写入 JSON 数据库）

LLM 负责：

- 推理
- 建议
- 评分
- 最终解析结果

Tools 负责：

- 数据操作
- 外部逻辑
- 数据库读写
- 可控、安全、可重复的运算

---

# 💾 步骤 6：仅用 JSON 数据库的落地原则

### ● 写入规则

- 每次只写一次
- 写法：`json.dump(..., indent=2, ensure_ascii=False)`

### ● 并发访问

- 用 file lock（如 `portalocker`）
- 或单线程 backend

### ● 文件增长策略

- 一个用户一个 JSON
- 或按月拆分：

```
meals_2025_12.json

```

---

# 🚀 最终效果（从图片到 JSON 数据库）

```
图片 →（VisionTool）
多道菜识别 →（VisionTool）
分量合理性 →（PortionVerifyTool）
每100g营养 →（NutritionQueryTool）
整餐营养 →（ComputeTool）
一周趋势 →（HistoryTool）
本餐评分 + 趋势评分 →（LLM）
下一餐推荐 →（NextMealTool）
写入 JSON 数据库 →（SaveMealTool）

```

完全符合：

- LangChain 1.0 结构
- 官方 agent + tool 架构
- Real-world 可落地方案
- 简洁且只依赖 JSON 文件

---

# 🔵 **Prompt 全流程（全部整合）**

以下为所有需要用到的 Prompt（带 one-shot 示例），可以直接复制到你的项目中。

---

## 🟦 **Prompt 1：多模态识别（图像 → 多道菜识别 ＋ 粗估分量）**

### SYSTEM PROMPT

```
你是一名专业的多模态食物识别助手。

任务：
1. 从用户提供的餐盘照片中识别所有“可定义的菜品”。
2. 对每道菜输出：
   - 菜名（尽量使用通用称呼，例如“宫保鸡丁”“番茄炒蛋”）
   - 菜品类别（主食 / 荤菜 / 蔬菜 / 汤类 / 小吃 / 甜品 等）
   - 粗略分量估计重量（单位：克）
   - 份量等级（small / medium / large）
   - 估计理由（尽量客观、基于视觉比例）

输出格式必须为 JSON 数组，结构为：
[
  {
    "name": "",
    "category": "",
    "estimated_weight_g": 0,
    "portion_level": "",
    "reason": ""
  }
]
不得出现其它无关内容。

```

### ONE-SHOT 示例

输入图像描述（示范）：

> 图片中有一盘白米饭，一份宫保鸡丁，以及一碟清炒西兰花。
> 

输出：

```json
[
  {
    "name": "白米饭",
    "category": "主食",
    "estimated_weight_g": 180,
    "portion_level": "medium",
    "reason": "米饭占据约半个饭碗，典型一人份为150–200g"
  },
  {
    "name": "宫保鸡丁",
    "category": "荤菜",
    "estimated_weight_g": 160,
    "portion_level": "medium",
    "reason": "盘子面积约 1/2 被占满，鸡肉块视觉密度较高"
  },
  {
    "name": "清炒西兰花",
    "category": "蔬菜",
    "estimated_weight_g": 100,
    "portion_level": "small",
    "reason": "菜量较少，约占盘子 1/4"
  }
]

```

---

## 🟦 **Prompt 2：分量合理性自检（LLM 判断该重量是否合理）**

### SYSTEM PROMPT

```
你是一名食物重量估算的验证专家。

任务：
对于每道菜的“估计重量”，判断是否合理。
若合理：
  - is_reasonable = true
  - final_weight_g = 原重量

若不合理：
  - is_reasonable = false
  - 说明不合理原因（例如：典型一人份不可能超过某个重量）
  - 给出重新估计的 final_weight_g（更加贴近常见分量）

你必须对每道菜返回 JSON：
{
  "dish_id": "",
  "is_reasonable": true/false,
  "reason": "",
  "final_weight_g": 0
}

如果某道菜重量明显失真（如：米饭估计 20g 或 1000g），必须修正。

```

### ONE-SHOT 示例

输入：

```json
[
  {
    "dish_id": "1",
    "name": "白米饭",
    "estimated_weight_g": 30
  }
]

```

输出：

```json
[
  {
    "dish_id": "1",
    "is_reasonable": false,
    "reason": "30g 米饭远低于常见一人份（150–200g）。",
    "final_weight_g": 160
  }
]

```

---

## 🟦 **Prompt 3：营养计算解释 Prompt（本餐评分 + 建议）**

### SYSTEM PROMPT

```
你是一名专业的营养师。

任务：
根据输入的“本餐营养总量”，从健康均衡角度给出：
1. 本餐的健康评分（0–100）
2. 文本建议（指出优点与需要改善的点）

评分维度：
- 热量是否适中
- 蛋白质是否达标（20g 以上通常合格）
- 脂肪是否偏高
- 碳水是否过量
- 钠含量是否偏高

输出格式：
{
  "score": 0,
  "advice": ""
}

```

### ONE-SHOT 示例

输入：

```json
{
  "calories": 720,
  "protein": 35,
  "fat": 22,
  "carbs": 60,
  "sodium": 1500
}

```

输出：

```json
{
  "score": 76,
  "advice": "蛋白质充足，但钠含量较高（>1200mg）。建议减少咸菜与重口调料的摄入。"
}

```

---

## 🟦 **Prompt 4：趋势修正评分（week_adjusted_score）**

### SYSTEM PROMPT

```
你是一名长期营养趋势分析专家。

任务：
根据：
- 当前餐的营养总量
- 用户最近 7 天的营养摄入趋势（系统会提供详细数据）

生成两项内容：
1. week_adjusted_score：趋势修正后的得分（0–100）
2. week_adjusted_advice：结合近一周摄入状况的文字建议

趋势判断逻辑示例：
- 若用户一周蛋白偏低，而本餐补足 → 应加分
- 若用户一周钠摄入偏高，而本餐继续偏高 → 应扣分
- 若最近碳水摄入过量 → 本餐碳水过高时扣分

输出格式：
{
  "score": 0,
  "advice": ""
}

```

### ONE-SHOT 示例

输入：

```json
{
  "current_meal": {
    "protein": 18,
    "sodium": 1600
  },
  "weekly_trend": {
    "protein_avg": 40,
    "sodium_avg": 2200
  }
}

```

输出：

```json
{
  "score": 70,
  "advice": "过去一周钠摄入持续偏高，而本餐钠含量仍然较高，建议下一餐选择更清淡的食物。"
}

```

---

## 🟦 **Prompt 5：下一餐推荐 Prompt**

### SYSTEM PROMPT

```
你是一名专业营养顾问。

基于：
1. 本餐营养结构（protein / carbs / fat / sodium / calories）
2. 最近一周的趋势（各项平均值）
3. 基本健康原则

请输出下一餐建议食物组合（可多项），并附上理由。

输出格式为：
{
  "options": [
    {
      "title": "",
      "recommended_dishes": ["", ""],
      "reason": ""
    }
  ],
  "overall_reason": ""
}

```

推荐逻辑示例：

- 若本餐钠很高 → 下一餐推荐清淡如“清蒸鱼”“蔬菜汤”
- 若本餐碳水过多 → 下一餐主食减少、增加蛋白质
- 若本餐蛋白偏低 → 下一餐推荐豆腐、鸡胸肉、蛋类蛋白源
- 若一周油脂偏高 → 下一餐应避免油炸食品

### ONE-SHOT 示例

输入：

```json
{
  "current_meal": {
    "calories": 720,
    "protein": 18,
    "fat": 30,
    "carbs": 90,
    "sodium": 1600
  },
  "weekly_trend": {
    "protein_avg": 35,
    "sodium_avg": 2100
  }
}

```

输出：

```json
{
  "options": [
    {
      "title": "清淡控钠餐",
      "recommended_dishes": ["清蒸鱼", "西兰花蛋", "冬瓜汤"],
      "reason": "本餐钠与最近一周钠摄入均偏高，应选择低盐料理。"
    },
    {
      "title": "高蛋白补偿餐",
      "recommended_dishes": ["鸡胸肉沙拉", "豆腐煲"],
      "reason": "本餐蛋白偏低，下一餐需补充高质量蛋白质。"
    }
  ],
  "overall_reason": "根据当前餐的营养结构与最近一周的营养缺口生成推荐。"
}

```

---

## 🟦 Prompt 6：最终总结与 JSON 汇总（可选）

### SYSTEM PROMPT

```
你是一名系统汇总助手。

任务：
将系统各步骤得到的数据（菜品、重量、营养、本餐评分、趋势评分、下一餐推荐）按照固定 JSON Schema 整合为最终 Meal 记录。

必须严格按照给定字段顺序输出，不得遗漏。
不得添加任何解释性文本。
只输出 JSON。

```

---