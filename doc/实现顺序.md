# ğŸ§± **ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®åˆå§‹åŒ–**

---

## **æ­¥éª¤ 1ï¼šåˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„**

```
ai-nutrition-agent/
â”œâ”€â”€ agent.py                      # ä¸» Agent æ–‡ä»¶
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ vision_tools.py           # Qwen-VL è¯†åˆ«æ¨¡å—
â”‚   â”œâ”€â”€ portion_tools.py          # åˆ†é‡åˆç†æ€§æ ¡éªŒ
â”‚   â”œâ”€â”€ nutrition_tools.py        # æ¯100gè¥å…»æŸ¥è¯¢
â”‚   â”œâ”€â”€ compute_tools.py          # è¥å…»è®¡ç®—
â”‚   â”œâ”€â”€ db_tools.py               # JSONæ•°æ®åº“è¯»å†™
â”‚   â””â”€â”€ recommendation_tools.py   # ä¸‹ä¸€é¤æ¨è
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ meal_schema.py
â”‚   â””â”€â”€ tool_schema.py
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ vision_prompt.txt
â”‚   â”œâ”€â”€ portion_prompt.txt
â”‚   â”œâ”€â”€ score_prompt.txt
â”‚   â”œâ”€â”€ trend_prompt.txt
â”‚   â”œâ”€â”€ nextmeal_prompt.txt
â”‚   â””â”€â”€ summary_prompt.txt
â”œâ”€â”€ db/
â”‚   â””â”€â”€ meals.json                # ä¸» JSON æ•°æ®åº“
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py               # æ¨¡å‹é…ç½®ï¼ˆQwenï¼‰
â””â”€â”€ requirements.txt

```

---

## **æ­¥éª¤ 2ï¼šå®‰è£…ä¾èµ–ï¼ˆå…¨éƒ¨å…¼å®¹ Qwen-VL + Qwen-Plusï¼‰**

```
python3 -m venv .venv
source .venv/bin/activate

pip install openai
pip install langchain langchain-core langchain-community langgraph
pip install pillow pandas numpy
pip install pydantic

```

ä½ å°†ä½¿ç”¨é˜¿é‡Œäº‘ Qwen å®˜æ–¹å…¼å®¹çš„ OpenAI æ ¼å¼ APIï¼š

```
from openai import OpenAI
client = OpenAI(api_key=..., base_url="https://dashscope.aliyuncs.com/compatible-mode/v1")

```

---

# ğŸ§© **ç¬¬äºŒéƒ¨åˆ†ï¼šå®šä¹‰ Schema**

ä¸å‰ç‰ˆä¸€è‡´ï¼Œåªéœ€è¦ä¿è¯æ•°æ®ç»“æ„æ”¯æŒå¤šé“èœã€‚

æ–‡ä»¶ï¼š`schemas/meal_schema.py`

ï¼ˆæ­¤å¤„ä¸å†å±•å¼€ï¼Œä¸ä½ ç¡®è®¤çš„ç‰ˆæœ¬ä¸€è‡´ï¼‰

---

# ğŸ”§ **ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥å…·å±‚å®ç°ï¼ˆå…¨éƒ¨åŸºäº Qwen æ¨¡å‹ï¼‰**

ä¸‹é¢æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼š

æ‰€æœ‰å·¥å…·å·¥å…·è°ƒç”¨å…¨éƒ¨å¯¹åº” Qwen ç³»åˆ—ã€‚

---

# ğŸŸ¦ **æ­¥éª¤ 3ï¼šå®ç° VisionToolï¼ˆä½¿ç”¨ Qwen-VL è¯†åˆ«å›¾åƒ + åˆ†é‡ç²—ä¼°ï¼‰**

æ–‡ä»¶ï¼š`tools/vision_tools.py`

```python
from openai import OpenAI
client = OpenAI(api_key=..., base_url="https://dashscope.aliyuncs.com/compatible-mode/v1")

@tool
def detect_dishes_and_portions(image_path: str):
    prompt = open("prompts/vision_prompt.txt").read()

    with open(image_path, "rb") as img:
        result = client.chat.completions.create(
            model="qwen-vl-plus",        # å¤šæ¨¡æ€æ¨¡å‹
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content":[
                    {"type":"input_image","image":img.read()},
                    {"type":"text","text":"è¯·è¯†åˆ«å›¾åƒå¹¶è¾“å‡º JSONã€‚"}
                ]}
            ]
        )

    return json.loads(result.choices[0].message["content"])

```

ä½œç”¨ï¼š

- ä½¿ç”¨ Qwen-VL-Plus è¾“å…¥å›¾åƒ
- è¾“å‡ºå¤šé“èœ JSON
- å†…å«ç²—åˆ†é‡ä¼°è®¡

---

# ğŸŸ¦ **æ­¥éª¤ 4ï¼šåˆ†é‡åˆç†æ€§æ ¡éªŒï¼ˆä½¿ç”¨ Qwen-Plusï¼‰**

æ–‡ä»¶ï¼š`tools/portion_tools.py`

```python
@tool
def check_and_refine_portions(dishes: List[dict]):
    prompt = open("prompts/portion_prompt.txt").read()

    result = client.chat.completions.create(
        model="qwen-plus",
        messages=[
            {"role":"system","content":prompt},
            {"role":"user","content":json.dumps(dishes, ensure_ascii=False)}
        ]
    )

    return json.loads(result.choices[0].message["content"])

```

Qwen-Plus ç”¨äºï¼š

- åˆ¤æ–­é‡é‡æ˜¯å¦åˆç†
- è‹¥ä¸åˆç† â†’ é‡ç®—

---

# ğŸŸ¦ **æ­¥éª¤ 5ï¼šè¥å…»æ•°æ®åº“æŸ¥è¯¢ï¼ˆæœ¬åœ° CSVï¼‰**

ä¸ä½ å‰ç‰ˆä¸€è‡´ï¼Œä¸ä¾èµ–æ¨¡å‹ã€‚

---

# ğŸŸ¦ **æ­¥éª¤ 6ï¼šæ•´é¤è¥å…»è®¡ç®—**

ä¸ä¾èµ–æ¨¡å‹ã€‚

---

# ğŸŸ¦ **æ­¥éª¤ 7ï¼šè¯»å–æœ€è¿‘ 7 å¤©è®°å½•**

åŒå‰ç‰ˆã€‚

---

# ğŸŸ¦ **æ­¥éª¤ 8ï¼šæœ¬é¤è¯„åˆ†ï¼ˆä½¿ç”¨ Qwen-Plusï¼‰**

æ–‡ä»¶ï¼š`tools/score_tools.py`

```python
def score_current_meal(nutrition: dict):
    prompt = open("prompts/score_prompt.txt").read()

    result = client.chat.completions.create(
        model="qwen-plus",
        messages=[
            {"role":"system","content":prompt},
            {"role":"user","content":json.dumps(nutrition, ensure_ascii=False)}
        ]
    )
    return json.loads(result.choices[0].message["content"])

```

---

# ğŸŸ¦ **æ­¥éª¤ 9ï¼šè¶‹åŠ¿ä¿®æ­£è¯„åˆ†ï¼ˆä½¿ç”¨ Qwen-Plusï¼‰**

æ–‡ä»¶ï¼š`tools/trend_tools.py`

```python
@tool
def score_weekly_adjusted(current: dict, weekly: dict):
    prompt = open("prompts/trend_prompt.txt").read()

    result = client.chat.completions.create(
        model="qwen-plus",
        messages=[
            {"role":"system","content":prompt},
            {"role":"user","content":json.dumps({
                "current_meal": current,
                "weekly_trend": weekly
            }, ensure_ascii=False)}
        ]
    )

    return json.loads(result.choices[0].message["content"])

```

---

# ğŸŸ¦ **æ­¥éª¤ 10ï¼šä¸‹ä¸€é¤æ¨èï¼ˆä½¿ç”¨ Qwen-Plusï¼‰**

æ–‡ä»¶ï¼š`tools/recommendation_tools.py`

```python
@tool
def recommend_next_meal(current: dict, weekly: dict):
    prompt = open("prompts/nextmeal_prompt.txt").read()

    result = client.chat.completions.create(
        model="qwen-plus",
        messages=[
            {"role":"system","content":prompt},
            {"role":"user","content":json.dumps({
                "current_meal": current,
                "weekly_trend": weekly
            }, ensure_ascii=False)}
        ]
    )

    return json.loads(result.choices[0].message["content"])

```

---

# ğŸŸ¦ **æ­¥éª¤ 11ï¼šä¿å­˜ç»“æœ**

ä¸å˜ã€‚

---

# ğŸ¤– **ç¬¬å››éƒ¨åˆ†ï¼šAgent ç»„è£…ï¼ˆæ ¸å¿ƒï¼‰**

æ–‡ä»¶ï¼š`agent.py`

```python
tools = [
    detect_dishes_and_portions,
    check_and_refine_portions,
    query_nutrition_per_100g,
    compute_meal_nutrition,
    load_recent_meals,
    score_current_meal,
    score_weekly_adjusted,
    recommend_next_meal,
    save_meal
]

agent = create_agent(
    model="qwen-plus",
    tools=tools,
    system_prompt="ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è¥å…»åˆ†æ Agentï¼Œè¯·ä¸¥æ ¼è°ƒç”¨å·¥å…·å¹¶ä¿æŒ JSON è¾“å‡ºã€‚"
)

```

---

# â–¶ï¸ **ç¬¬äº”éƒ¨åˆ†ï¼šæ‰§è¡Œå®Œæ•´æµç¨‹**

è¾“å…¥å›¾ç‰‡ï¼š

```python
result = agent.invoke({
    "image_path": "meal.jpg",
    "user_id": "user001"
})

```

---

# ğŸ“¦ **ç¬¬å…­éƒ¨åˆ†ï¼šæµ‹è¯•æ–¹æ³•**

ä½ å°†å¾—åˆ°ï¼š

- å¤šé“èœè¯†åˆ«
- åˆç†åˆ†é‡
- è¥å…»å€¼
- æœ¬é¤è¯„åˆ†
- å‘¨è¶‹åŠ¿è¯„åˆ†
- ä¸‹ä¸€é¤å»ºè®®
- JSON æ•°æ®åº“è‡ªåŠ¨æ›´æ–°

---